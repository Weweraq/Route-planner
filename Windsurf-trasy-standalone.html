<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Windsurf-trasy (standalone)</title>
    <style>
        body { font-family: Arial, sans-serif; margin:0; padding:0; }
        #container { display: flex; height: 100vh; }
        #sidebar { width: 350px; background: #f0f0f0; padding: 20px; }
        #map { flex: 1; position: relative; }
        #gmap { width: 100%; height: 100%; }
        .input-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 4px; }
        input, select, button { width: 100%; padding: 7px; margin-bottom: 5px; box-sizing: border-box; }
        #route-details { margin-top: 20px; background: #fff; padding: 10px; border-radius: 5px; }
        .waypoint-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            background: #e9e9e9;
            border-radius: 4px;
            padding: 2px 4px;
        }
        .waypoint-row input.waypoint {
            flex: 1;
            margin: 0 4px;
            padding: 5px 7px;
            font-size: 15px;
            height: 28px;
            min-width: 0;
        }
        .drag-handle {
            font-size: 18px;
            margin-right: 6px;
            color: #888;
            user-select: none;
            cursor: move;
            width: 18px;
            text-align: center;
        }
        .remove-waypoint {
            width: 24px;
            height: 24px;
            font-size: 16px;
            background: #fff;
            color: #d00;
            border: 1px solid #ccc;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin-left: 4px;
            margin-right: 2px;
        }
        .remove-waypoint:hover {
            background: #fee;
            border-color: #d00;
        }
        .sortable-ghost {
            opacity: 0.6;
        }
        .point-label {
            font-weight: bold;
            width: 22px;
            display: inline-block;
            text-align: center;
            margin-right: 6px;
        }
        .suggestions {
            position: relative;
            z-index: 100;
        }
        .suggestion-list {
            position: absolute;
            left: 0; right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-top: none;
            max-height: 120px;
            overflow-y: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        .suggestion-item {
            padding: 6px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background: #e0e0e0;
        }
    </style>
</head>
<body>
<div id="container">
    <div id="sidebar">
        <h2>LKQ route planner</h2>
        <div class="input-group">
            <label for="start">Start:</label>
            <input id="start" type="text" class="autocomplete-input" placeholder="Zadejte výchozí bod" style="width:100%;">
        </div>
        <div id="waypoints-list" class="input-group"></div>
        <button id="add-waypoint" type="button">Přidat zastávku</button>
        <div class="input-group">
            <label for="end">Cíl:</label>
            <input id="end" type="text" class="autocomplete-input" placeholder="Zadejte cílový bod" style="width:100%;">
        </div>
        <div class="input-group">
            <label for="excel-upload">Načíst adresy z Excelu (.xlsx):</label>
            <input type="file" id="excel-upload" accept=".xlsx">
        </div>
        <div class="input-group">
            <label for="departure-time">Čas odjezdu:</label>
            <input type="datetime-local" id="departure-time">
        </div>
        <div class="input-group highway-checkbox-row">
            <label for="pouzit-highways" style="display:flex;align-items:center;gap:12px;font-size:1.25em;">
                <input type="checkbox" id="pouzit-highways" checked style="width:28px;height:28px;">
                <span style="font-size:1.25em;">Použít dálnice</span>
            </label>
        </div>
        <button id="plan-route">Naplánovat trasu</button>
        <div style="display:flex; gap:8px; margin-bottom:10px;">
            <button id="export-excel" type="button">Export do Excelu</button>
            <button id="export-gps" type="button">Export GPS souřadnic</button>
        </div>
        <div id="route-details"></div>
    </div>
    <div id="map">
        <div id="gmap" style="height:100%;width:100%;"></div>
    </div>
</div>
<!-- XLSX knihovna -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<!-- Sortable.js pro drag&drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<!-- Google Maps API (nutno mít internet a API klíč) -->
<!-- Google Maps API bude načten dynamicky přes main.js -->
<script>
// --- Začátek JS kódu (obsah main.js) ---
// Hlavní deklarace globálních proměnných
let map, directionsService, directionsRenderer;
let lastRouteAddresses = [];
let lastRouteCoords = [];
let autocompleteInputs = [];

function getWaypoints() {
    // Vrací pole hodnot waypoint inputů (mezi startem a cílem)
    return Array.from(document.querySelectorAll('#waypoints-list input.waypoint'))
        .map(inp => inp.value.trim())
        .filter(Boolean);
}

function updatePointLabels() {
    // Nastaví písmenka (A, B, C, ...) ke všem bodům (start, waypointy, cíl)
    const startLabel = document.querySelector('label[for="start"]');
    if (startLabel) {
        let span = startLabel.querySelector('.point-label');
        if (!span) {
            span = document.createElement('span');
            span.className = 'point-label';
            span.style.fontWeight = 'bold';
            span.style.width = '22px';
            span.style.display = 'inline-block';
            span.style.textAlign = 'center';
            span.style.marginRight = '6px';
            startLabel.prepend(span);
        }
        span.textContent = 'A';
    }
    // Waypointy
    const waypointRows = document.querySelectorAll('#waypoints-list .waypoint-row');
    waypointRows.forEach((row, idx) => {
        let span = row.querySelector('.point-label');
        if (span) span.textContent = String.fromCharCode('B'.charCodeAt(0) + idx);
    });
    // Cíl
    const endLabel = document.querySelector('label[for="end"]');
    if (endLabel) {
        let span = endLabel.querySelector('.point-label');
        if (!span) {
            span = document.createElement('span');
            span.className = 'point-label';
            span.style.fontWeight = 'bold';
            span.style.width = '22px';
            span.style.display = 'inline-block';
            span.style.textAlign = 'center';
            span.style.marginRight = '6px';
            endLabel.prepend(span);
        }
        span.textContent = String.fromCharCode('B'.charCodeAt(0) + waypointRows.length);
    }
}

function initGoogleAutocomplete() {
    // Inicializuj Google Autocomplete na všech inputech s třídou autocomplete-input
    const inputs = document.querySelectorAll('input.autocomplete-input');
    inputs.forEach(input => {
        if (!input._autocomplete) {
            input._autocomplete = new google.maps.places.Autocomplete(input, {
                types: ['geocode'],
                componentRestrictions: {country: 'cz'}
            });
        }
    });
}

document.addEventListener('DOMContentLoaded', function() {
    // Po načtení stránky inicializuj autocomplete
    initGoogleAutocomplete();
    // Vždy začni s prázdným seznamem waypointů
    document.getElementById('waypoints-list').innerHTML = '';
    addWaypointInput(''); // První prázdná zastávka (uživatel může smazat)
    enableWaypointDragDrop();
    updatePointLabels();
});

function enableWaypointDragDrop() {
    if (window.Sortable && document.getElementById('waypoints-list')) {
        new Sortable(document.getElementById('waypoints-list'), {
            animation: 150,
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            onEnd: function() {
                initGoogleAutocomplete(); // Po přesunu znovu naváž autocomplete
                planRoute();
                updatePointLabels();
            }
        });
    }
}

function planRoute() {
    const start = document.getElementById('start').value.trim();
    const end = document.getElementById('end').value.trim();
    const waypoints = getWaypoints();
    updatePointLabels();
    if (!start || !end) {
        document.getElementById('route-details').innerText = 'Zadejte start a cíl.';
        return;
    }
    let wp = waypoints.map(addr => ({location: addr, stopover: true}));
    const dtInput = document.getElementById('departure-time');
    let depTime = new Date();
    if (dtInput && dtInput.value) {
        depTime = new Date(dtInput.value);
    }
    let useHighways = document.getElementById('pouzit-highways').checked;
    let request = {
        origin: start,
        destination: end,
        travelMode: 'DRIVING',
        drivingOptions: {
            departureTime: depTime,
            trafficModel: 'bestguess'
        },
        avoidTolls: false
    };
    if (wp.length > 0) {
        request.waypoints = wp;
    }
    request.avoidHighways = !useHighways;
    if (!window.google || !window.google.maps || !window.google.maps.DirectionsService) {
        document.getElementById('route-details').innerText = 'Google Maps není dostupný.';
        return;
    }
    if (!directionsService) directionsService = new google.maps.DirectionsService();
    if (!directionsRenderer) directionsRenderer = new google.maps.DirectionsRenderer({map: map});
    directionsService.route(request, function(result, status) {
        if (status === 'OK') {
            directionsRenderer.setDirections(result);
            showRouteDetails(result.routes[0], depTime, useHighways, wp.length);
        } else {
            document.getElementById('route-details').innerText = 'Trasa nenalezena.';
        }
    });
}

function addWaypointInput(val = '') {
    const list = document.getElementById('waypoints-list');
    const div = document.createElement('div');
    div.className = 'waypoint-row';
    div.style.display = 'flex';
    div.style.alignItems = 'center';
    div.innerHTML = `<span class="drag-handle" style="cursor:move;margin-right:6px;">☰</span>
        <span class="point-label" style="font-weight:bold;width:22px;text-align:center;margin-right:6px;"></span>
        <input type="text" class="waypoint autocomplete-input" placeholder="Zastávka" style="flex:1">
        <button type="button" class="remove-waypoint" style="margin-left:4px;">✖</button>`;
    list.appendChild(div);
    const input = div.querySelector('input.waypoint');
    if (val) input.value = val;
    div.querySelector('.remove-waypoint').onclick = () => {
        div.remove();
        planRoute();
        updatePointLabels();
    };
    initGoogleAutocomplete(); // Inicializuj autocomplete na novém inputu
    enableWaypointDragDrop(); // Zajisti drag&drop i po přidání
    updatePointLabels();
}

// Bind tlačítko pro přidání waypointu
if (document.getElementById('add-waypoint')) {
    document.getElementById('add-waypoint').onclick = () => addWaypointInput('');
}

document.getElementById('export-excel').onclick = function() {
    // Získej aktuální plán trasy včetně písmenek a typů
    const start = document.getElementById('start').value.trim();
    const end = document.getElementById('end').value.trim();
    const waypoints = Array.from(document.querySelectorAll('#waypoints-list input.waypoint')).map(inp => inp.value.trim()).filter(Boolean);
    const rows = [];
    if (start) rows.push({letter: 'A', type: 'Start', address: start});
    waypoints.forEach((addr, idx) => {
        rows.push({letter: String.fromCharCode('B'.charCodeAt(0) + idx), type: 'Zastávka', address: addr});
    });
    if (end) rows.push({letter: String.fromCharCode('B'.charCodeAt(0) + waypoints.length), type: 'Cíl', address: end});
    const ws_data = [
        ['Písmeno', 'Typ', 'Adresa'],
        ...rows.map(r => [r.letter, r.type, r.address])
    ];
    let ws = XLSX.utils.aoa_to_sheet(ws_data);
    let wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Trasa');
    XLSX.writeFile(wb, 'trasa.xlsx');
};

document.getElementById('export-gps').onclick = function() {
    if (!lastRouteCoords.length) return;
    let csv = 'lat,lng,adresa\n' + lastRouteCoords.map(r => `${r[0]},${r[1]},"${r[2].replace(/"/g,'""')}"`).join('\n');
    let blob = new Blob([csv], {type: 'text/csv'});
    let url = URL.createObjectURL(blob);
    let a = document.createElement('a');
    a.href = url;
    a.download = 'trasa_gps.csv';
    document.body.appendChild(a);
    a.click();
    setTimeout(() => { document.body.removeChild(a); URL.revokeObjectURL(url); }, 100);
};

document.getElementById('plan-route').onclick = planRoute;

// Excel upload
function initExcelUpload() {
    document.getElementById('excel-upload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            let addresses = XLSX.utils.sheet_to_json(sheet, {header: 1}).flat().filter(Boolean);
            // Pokud první řádek vypadá jako hlavička, přeskoč ho
            if (addresses[0] && typeof addresses[0] === 'string' && addresses[0].toLowerCase().includes('adresa')) {
                addresses = addresses.slice(1);
            }
            if (addresses.length >= 2) {
                // naplnit start, waypointy, cíl
                const start = addresses[0];
                const end = addresses[addresses.length-1];
                const waypoints = addresses.slice(1, -1);
                initWaypoints(start, end, waypoints);
            }
        };
        reader.readAsArrayBuffer(file);
    });
}
initExcelUpload();

function initWaypoints(startVal = '', endVal = '', waypointsArr = ['']) {
    // Start
    document.getElementById('start').value = startVal;
    // Waypointy
    const list = document.getElementById('waypoints-list');
    list.innerHTML = '';
    (waypointsArr && waypointsArr.length ? waypointsArr : ['']).forEach(val => addWaypointInput(val));
    // Cíl
    document.getElementById('end').value = endVal;
}

// Google Maps init
function initMap() {
    map = new google.maps.Map(document.getElementById('gmap'), {
        center: {lat: 49.8, lng: 15.5},
        zoom: 7,
        mapTypeId: 'roadmap',
        streetViewControl: false,
        fullscreenControl: false
    });
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({map: map});
}
window.initMap = initMap;
// --- Konec JS kódu ---
</script>
<!-- POZOR: Pokud chceš používat mapu a autocomplete, musíš mít internet a platný Google Maps API klíč! -->
</body>
</html>
